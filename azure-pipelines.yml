# Starter pipeline
# Multi-target build for JamesConsulting across all declared TargetFrameworks.
# Installs required SDKs (including preview) so all TFMs build & test.
variables:
  - group: 'Code Signing'

trigger:
  - master

pool:
  vmImage: 'windows-latest'

steps:
  # Install .NET SDKs needed for multi-target project.
  - task: UseDotNet@2
    displayName: 'Install .NET 6 SDK'
    inputs:
      packageType: sdk
      version: '6.0.x'
  - task: UseDotNet@2
    displayName: 'Install .NET 7 SDK'
    inputs:
      packageType: sdk
      version: '7.0.x'
  - task: UseDotNet@2
    displayName: 'Install .NET 8 SDK'
    inputs:
      packageType: sdk
      version: '8.0.x'
  - task: UseDotNet@2
    displayName: 'Install .NET 9 SDK (preview)'
    inputs:
      packageType: sdk
      version: '9.0.x'
      includePreviewVersions: true
  - task: UseDotNet@2
    displayName: 'Install .NET 10 SDK (preview)'
    inputs:
      packageType: sdk
      version: '10.0.x'
      includePreviewVersions: true

  - task: SonarCloudPrepare@2
    inputs:
      SonarCloud: 'James Consulting'
      organization: 'james-consulting-llc'
      scannerMode: 'MSBuild'
      projectKey: '$(SonarKey)'
      projectVersion: '2.0'

  - task: DotNetCoreCLI@2
    displayName: 'Restore (all TFMs)'
    inputs:
      command: 'restore'
      feedsToUse: 'select'
      projects: 'src/JamesConsulting.sln'

  - task: DotNetCoreCLI@2
    displayName: 'Install NuGetKeyVaultSignTool'
    inputs:
      command: 'custom'
      custom: 'tool'
      arguments: 'install --tool-path . NuGetKeyVaultSignTool'

  - task: DotNetCoreCLI@2
    displayName: 'Build (all TFMs)'
    inputs:
      command: 'build'
      projects: 'src/JamesConsulting.sln'
      versioningScheme: byBuildNumber
      arguments: '--configuration $(buildConfiguration) --no-restore -p MetalamaLicense=$(MetalamaLicense)'

  - task: DotNetCoreCLI@2
    displayName: 'Test (multi-target)'
    inputs:
      command: test
      projects: 'src/**/*.Tests/*.csproj'
      arguments: '--configuration $(buildConfiguration) --collect "Code coverage"'

  # Optional separate net462 test run if needed (uncomment if DotNetCoreCLI test skips net462 framework):
  # - task: VsTest@2
  #   displayName: 'Run net462 tests'
  #   inputs:
  #     testAssemblyVer2: |
  #       **/bin/$(buildConfiguration)/net462/*Tests.dll
  #     searchFolder: 'src'
  #     runInParallel: true

  - task: DotNetCoreCLI@2
    displayName: 'Pack (multi-target nupkg)'
    inputs:
      command: 'pack'
      packagesToPack: 'src/**/JamesConsulting.csproj'
      nobuild: true
      versioningScheme: 'byEnvVar'
      versionEnvVar: Version
      arguments: '--configuration $(buildConfiguration)'

  # Code signing step (disabled). Enable when Key Vault cert is ready.
  # - task: PowerShell@2
  #   displayName: 'Code Sign NuGet Package'
  #   inputs:
  #     targetType: 'inline'
  #     script: |
  #       .\NuGetKeyVaultSignTool sign ./src/**/bin/$(buildConfiguration)/*.nupkg `
  #       --file-digest "sha256" `
  #       --timestamp-rfc3161 "http://ts.ssl.com" `
  #       --timestamp-digest "sha256" `
  #       --azure-key-vault-url "https://jc-code-signing.vault.azure.net/" `
  #       --azure-key-vault-tenant-id "a2bc6fb5-fba9-40b4-9ecc-2acf61cae876" `
  #       --azure-key-vault-client-id "$(ApplicationId)" `
  #       --azure-key-vault-client-secret "$(ClientSecret)" `
  #       --azure-key-vault-certificate "jc-code-signing"

  - task: SonarCloudAnalyze@2

  - task: SonarCloudPublish@2
    inputs:
      pollingTimeoutSec: '300'

  - task: CopyFiles@2
    displayName: 'Copy nupkg to Artifact Staging'
    inputs:
      Contents: 'src/**/bin/$(buildConfiguration)/*.nupkg'
      TargetFolder: '$(build.artifactstagingdirectory)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: drop'
