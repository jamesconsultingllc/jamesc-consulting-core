# Starter pipeline
# Multi-target build for JamesConsulting across all declared TargetFrameworks.
# Installs required SDKs (including preview) so all TFMs build & test.
variables:
  - group: 'Code Signing'

trigger:
  - master

pool:
  vmImage: 'windows-latest'

steps:
  # Install .NET SDKs needed for multi-target project.
  - task: UseDotNet@2
    displayName: 'Install .NET 6 SDK'
    inputs:
      packageType: sdk
      version: '6.0.x'
  - task: UseDotNet@2
    displayName: 'Install .NET 7 SDK'
    inputs:
      packageType: sdk
      version: '7.0.x'
  - task: UseDotNet@2
    displayName: 'Install .NET 8 SDK'
    inputs:
      packageType: sdk
      version: '8.0.x'
  - task: UseDotNet@2
    displayName: 'Install .NET 9 SDK (preview)'
    inputs:
      packageType: sdk
      version: '9.0.x'
      includePreviewVersions: true
  - task: UseDotNet@2
    displayName: 'Install .NET 10 SDK (preview)'
    inputs:
      packageType: sdk
      version: '10.0.x'
      includePreviewVersions: true

  - task: DotNetCoreCLI@2
    displayName: 'Restore (all TFMs)'
    inputs:
      command: 'restore'
      feedsToUse: 'select'
      projects: 'src/JamesConsulting.sln'

  - task: DotNetCoreCLI@2
    displayName: 'Install NuGetKeyVaultSignTool'
    inputs:
      command: 'custom'
      custom: 'tool'
      arguments: 'install --tool-path . NuGetKeyVaultSignTool'

  - task: DotNetCoreCLI@2
    displayName: 'Build (all TFMs)'
    inputs:
      command: 'build'
      projects: 'src/JamesConsulting.sln'
      versioningScheme: byBuildNumber
      arguments: '--configuration $(buildConfiguration) --no-restore -p MetalamaLicense=$(MetalamaLicense)'

  - task: DotNetCoreCLI@2
    displayName: 'Test (multi-target)'
    inputs:
      command: test
      projects: 'src/**/*.Tests/*.csproj'
      arguments: '--configuration $(buildConfiguration) --collect "Code coverage"'

  - task: DotNetCoreCLI@2
    displayName: 'Pack (multi-target nupkg)'
    inputs:
      command: 'pack'
      packagesToPack: 'src/**/JamesConsulting.csproj'
      nobuild: true
      versioningScheme: 'byEnvVar'
      versionEnvVar: Version
      arguments: '--configuration $(buildConfiguration)'

  - task: CopyFiles@2
    displayName: 'Copy nupkg to Artifact Staging'
    inputs:
      Contents: 'src/**/bin/$(buildConfiguration)/*.nupkg'
      TargetFolder: '$(build.artifactstagingdirectory)'

  - task: PowerShell@2
    displayName: 'Code Sign NuGet Package with Azure TrustedSigning'
    inputs:
      targetType: 'inline'
      script: |
        $moduleName = "TrustedSigning"
        if (-not (Get-Module -ListAvailable -Name $moduleName)) {
            Write-Host "Installing TrustedSigning module..."
            Install-Module -Name $moduleName -Force -Scope CurrentUser
        }

        $endpoint = "https://eus.codesigning.azure.net"
        $accountName = "jc-ts-account"
        $profileName = "Code-Signing"
        $folder = "$env:BUILD_ARTIFACTSTAGINGDIRECTORY"
        $filter = "nupkg"
        $fileDigest = "SHA256"
        $timestampUrl = "http://timestamp.acs.microsoft.com"
        $timestampDigest = "SHA256"

        $nupkgFiles = Get-ChildItem -Path $folder -Filter "*.nupkg" -Recurse

        if ($nupkgFiles.Count -eq 0) {
            Write-Host "No NuGet packages (.nupkg) found in $folder."
            exit 0
        }

        Write-Host "Signing NuGet packages in $folder..."

        Invoke-TrustedSigning `
            -Endpoint $endpoint `
            -CodeSigningAccountName $accountName `
            -CertificateProfileName $profileName `
            -FilesFolder $folder `
            -FilesFolderFilter $filter `
            -FileDigest $fileDigest `
            -TimestampRfc3161 $timestampUrl `
            -TimestampDigest $timestampDigest

        Write-Host "Signing complete."

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: drop'
